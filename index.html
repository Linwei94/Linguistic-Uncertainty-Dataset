<!-- hedging_confidence_annotation_mobile.html (v12.0)
Changes:
1. Replaced slider with six discrete buttons (0‑5) to capture confidence levels.
2. Updated example gold scores to match 0‑5 scale.
3. Auto‑loads `sentences.csv` if detected in same directory; falls back to manual upload.
4. Kept Google Sheets submission logic (no‑cors).
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confidence Annotation Task</title>

    <!-- ========= STYLES ========= -->
    <style>
      :root {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        --primary: #4caf50;
        --secondary: #e0e0e0;
      }
      body {
        margin: 0;
        padding: 1rem;
        background: #fafafa;
        color: #222;
        padding-bottom: 160px; /* prevent footer overlap */
      }
      h2, h3 { margin-top: 0; }

      /* Generic buttons */
      button {
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        padding: 0.7rem 1rem;
        background: var(--primary);
        color: #fff;
      }
      button:disabled { opacity: 0.5; }

      .btn-row { display: flex; justify-content: space-between; gap: 4%; margin-top: 0.75rem; }

      /* Fixed footer */
      .bottom-fixed { position: fixed; left: 0; right: 0; bottom: 0; padding: 1rem; background: #fafafa; box-shadow: 0 -2px 6px rgba(0,0,0,.1); }

      /* Scale buttons */
      .scale-group { display: flex; justify-content: space-between; gap: 4px; margin-top: 0.6rem; }
      .scale-btn {
        flex: 1 1 0;
        background: var(--secondary);
        color: #222;
        padding: 0.6rem 0;
        border-radius: 0.5rem;
        font-weight: 600;
      }
      .scale-btn.selected { background: var(--primary); color: #fff; }

      /* Progress */
      .progress-wrapper{height:8px;background:var(--secondary);border-radius:4px;overflow:hidden;margin-top:.6rem;}
      .progress-bar{height:100%;background:var(--primary);width:0%;}

      .sentence-box{font-size:1.3rem;line-height:1.5;margin-bottom:1rem;}
      ul{padding-left:1.2rem;} li{margin-bottom:.5rem;}
      .error{color:#d32f2f;margin-top:1rem;} .small{font-size:.85rem;color:#555;}
    </style>
  </head>

  <body>
    <div id="app">Loading…</div>

    <!-- Papa Parse – CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!--
      ===== GOOGLE SHEETS BACKEND =====
      See v11.x comment block for full instructions.
    -->

    <script>
    (function(){
      /* ========= CONFIG ========= */
      const TOTAL_ITEMS_TARGET = 105;
      const CONTROL_ITEMS_NEEDED = 5;
      const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxttuiEEZaIT9N8B_xNrwW8d3LC_BzN8ax9xAv78Kr0n3Cbd6RPFXS2uvfFKwT5t5dX_Q/exec"; // update if needed
      const EXAMPLES = [
        { sentence: "It might rain later this evening.", gold: 2 },
        { sentence: "I am almost certain the meeting starts at 10 am.", gold: 5 },
        { sentence: "Evidence for chaos is hardly conclusive at this Reynolds number.", gold: 1 }
      ];

      /* ========= STATE ========= */
      const annotatorId = crypto.randomUUID?.() || `id-${Date.now()}-${Math.random().toString(36).slice(2)}`;
      let dataset = [], taskItems = [], answers = [];
      let currentIndex = -1, startTimestamp = null, timerHandle = null;

      /* ========= HELPERS ========= */
      const $ = sel => document.querySelector(sel);
      const shuffle = arr => arr.sort(() => Math.random() - 0.5);
      const zeroPad = n => String(n).padStart(2, "0");
      const fmtTime = s => `${zeroPad(Math.floor(s/3600))}:${zeroPad(Math.floor((s%3600)/60))}:${zeroPad(s%60)}`;

      /* ========= TIMER ========= */
      function tick(){ const el = $("#timer"); if(el) el.textContent = `⏱ ${fmtTime(Math.floor((Date.now()-startTimestamp)/1000))}`; }
      function startTimer(){ startTimestamp = Date.now(); stopTimer(); timerHandle = setInterval(tick, 1000); }
      function stopTimer(){ if(timerHandle) clearInterval(timerHandle); timerHandle = null; }

      /* ========= INTRO & CSV LOAD ========= */
      function intro(manualMode=false){
        $("#app").innerHTML = `
          <h2>Confidence Annotation Task</h2>
          <p>Your annotator ID: <strong>${annotatorId}</strong></p>
          <div id="timer" class="small"></div>
          ${manualMode ? `<p>Select a <code>.csv</code> file containing sentences to label.</p>
          <input type="file" id="csvFile" accept=".csv" />
          <br><br>
          <button id="loadBtn" disabled style="width:100%">Load & Start</button>
          <div id="status" class="small"></div>` : `<p><em>Auto‑loaded <code>sentences.csv</code>.</em></p>`}
          <hr>
          <h3>Examples (0 = very uncertain, 5 = absolutely confident)</h3>
          <ul>${EXAMPLES.map(e=>`<li>“${e.sentence}” → <em>${e.gold}</em></li>`).join("")}</ul>`;

        if(manualMode){
          $("#csvFile").addEventListener("change", ev => {
            const file = ev.target.files[0]; $("#loadBtn").disabled = !file;
            $("#loadBtn").onclick = () => { $("#status").textContent = "Parsing…"; parseCSV(file); };
          });
        }
      }

      function error(msg){ $("#status").innerHTML = `<span class="error">${msg}</span>`; }

      // Attempt auto‑load on startup
      fetch("sentences.csv").then(r=>r.ok?r.text():Promise.reject()).then(text=>{
        Papa.parse(text,{header:true,skipEmptyLines:true,complete:res=>{
          if(res.errors.length) return intro(true);
          autoLoadFromParse(res);
        }});
      }).catch(()=>intro(true)); // fallback to manual

      function autoLoadFromParse(res){
        const fields = res.meta.fields;
        const key = fields.find(h=>/sentence|text|句子/i.test(h)) || fields[0];
        dataset = res.data.map((row,i)=>({csvIndex:i+1,sentence:row[key],gold_confidence:row.gold_confidence||row.Gold||""})).filter(r=>r.sentence&&r.sentence.trim());
        if(!dataset.length){ intro(true); return; }
        buildTask();
      }

      function parseCSV(file){
        Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>{
          if(res.errors.length) return error(res.errors[0].message);
          const fields = res.meta.fields;
          const key = fields.find(h=>/sentence|text|句子/i.test(h)) || fields[0];
          dataset = res.data.map((row,i)=>({csvIndex:i+1,sentence:row[key],gold_confidence:row.gold_confidence||row.Gold||""})).filter(r=>r.sentence&&r.sentence.trim());
          if(!dataset.length) return error("No valid sentences.");
          buildTask();
        },error:err=>error(err.message)});
      }

      /* ========= BUILD TASK ========= */
      function buildTask(){
        const controls = shuffle(dataset.filter(r=>r.gold_confidence)).slice(0, CONTROL_ITEMS_NEEDED);
        const rest = shuffle(dataset.filter(r=>!r.gold_confidence)).slice(0, TOTAL_ITEMS_TARGET - controls.length);
        taskItems = shuffle([...controls, ...rest]);
        answers = new Array(taskItems.length);
        currentIndex = -1;
        startTimer();
        next();
      }

      /* ========= RENDER ========= */
      function render(item){
        const progressPercent = (currentIndex / taskItems.length) * 100;
        const stored = answers[currentIndex];
        const selectedVal = stored ? stored.score : null;

        $("#app").innerHTML = `
          <div id="timer" class="small"></div>
          <div class="sentence-box">${item.sentence}</div>
          <div class="bottom-fixed">
            <label class="slider-label">Select confidence level (0–5):</label>
            <div class="scale-group" id="scaleGroup">
              ${[0,1,2,3,4,5].map(v=>`<button class="scale-btn${v===selectedVal?" selected":""}" data-val="${v}">${v}</button>`).join("")}
            </div>
            <div class="progress-wrapper"><div class="progress-bar" style="width:${progressPercent}%"></div></div>
            <div class="btn-row">
              <button id="prevBtn" ${currentIndex===0?"disabled":""}>◀ Prev</button>
              <button id="nextBtn" ${selectedVal==null?"disabled":""}>Next ▶ (${currentIndex+1}/${taskItems.length})</button>
            </div>
          </div>`;

        tick();

        // Scale buttons logic
        $("#scaleGroup").addEventListener("click", ev => {
          if(!ev.target.classList.contains("scale-btn")) return;
          const val = Number(ev.target.dataset.val);
          [...$("#scaleGroup").children].forEach(btn=>btn.classList.remove("selected"));
          ev.target.classList.add("selected");
          $("#nextBtn").disabled = false;
          store(val);
        });

        $("#nextBtn").onclick = () => next();
        $("#prevBtn").onclick = () => { if(currentIndex>0){ currentIndex--; render(taskItems[currentIndex]); } };
      }

      /* ========= DATA ========= */
      function store(score){
        const item = taskItems[currentIndex];
        answers[currentIndex] = {
          annotatorId,
          csvIndex: item.csvIndex,
          order: currentIndex,
          sentence: item.sentence,
          score,
          isControl: !!item.gold_confidence,
          gold: item.gold_confidence ? Number(item.gold_confidence) : null
        };
      }

      /* ========= NAVIGATION ========= */
      function next(){
        currentIndex++;
        if(currentIndex >= taskItems.length) finish(); else render(taskItems[currentIndex]);
      }

      /* ========= FINISH ========= */
      function finish(){
        stopTimer();
        const data = answers.filter(Boolean);
        $("#app").innerHTML = `<h2>Submitting…</h2><p>Posting to Google Sheet. Please wait.</p><div id="sheetStatus" class="small"></div>`;
        fetch(SHEET_WEBAPP_URL,{method:"POST",mode:"no-cors",body:JSON.stringify(data)})
          .then(()=>$("#sheetStatus").innerHTML='<span style="color:#4caf50">✅ Data sent! If you don’t see it in the Sheet, check Apps Script permissions.</span>')
          .catch(err=>fallback(data,err));
      }

      function fallback(data,err){
        console.error(err);
        const csv = Papa.unparse(data);
        $("#sheetStatus").innerHTML = `<span class="error">❌ Post failed (${err.message}). Copy CSV below:</span><textarea style="width:100%;height:120px;margin-top:8px">${csv}</textarea>`;
      }
    })();
    </script>
  </body>
</html>
